<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Pingpong 测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #result, #connectionStatus { margin-top: 20px; }
        #pingpongControls { display: none; }
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4caf50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>WebRTC Pingpong 测试</h1>
    <div>
        <label for="signalServer">信令服务器：</label>
        <input type="text" id="signalServer" value="ws://127.0.0.1:3000">
    </div>
    <div>
        <label for="role">选择角色：</label>
        <select id="role">
            <option value="none">未选择</option>
            <option value="initiator">发起者</option>
            <option value="receiver">接收者</option>
        </select>
    </div>
    
    <div id="connectionStatus"></div>

    <div id="pingpongControls">
        <button id="startPingpong">开始 Pingpong</button>
        <button id="stopPingpong" style="display:none;">停止 Pingpong</button>
    </div>

    <div id="result"></div>

    <div id="notification"></div>

    <script>
        const roleSelect = document.getElementById('role');
        const connectionStatus = document.getElementById('connectionStatus');
        const pingpongControls = document.getElementById('pingpongControls');
        const startPingpongButton = document.getElementById('startPingpong');
        const stopPingpongButton = document.getElementById('stopPingpong');
        const resultDiv = document.getElementById('result');
        const notificationDiv = document.getElementById('notification');
        const signalServerInput = document.getElementById('signalServer');

        let peerConnection;
        let dataChannel;
        let pingpongInterval;
        let isInitiator = false;
        let iceCandidates = [];
        let socket;

        const createPeerConnection = () => {
            peerConnection = new RTCPeerConnection();
            
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log("新的ICE候选：", JSON.stringify(event.candidate));
                    iceCandidates.push(event.candidate);
                    socket.send(JSON.stringify({ type: 'ice-candidate', candidate: event.candidate }));
                }
            };

            peerConnection.onconnectionstatechange = () => {
                console.log(`连接状态变更：${peerConnection.connectionState}`);
                connectionStatus.textContent = `连接状态：${peerConnection.connectionState}`;
                if (peerConnection.connectionState === 'connected') {
                    pingpongControls.style.display = 'block';
                } else {
                    pingpongControls.style.display = 'none';
                }
            };

            peerConnection.onicegatheringstatechange = () => {
                console.log(`ICE收集状态：${peerConnection.iceGatheringState}`);
            };

            peerConnection.onsignalingstatechange = () => {
                console.log(`信令状态：${peerConnection.signalingState}`);
            };
        };

        const createDataChannel = () => {
            dataChannel = peerConnection.createDataChannel("pingpongChannel");
            setupDataChannel();
        };

        const setupDataChannel = () => {
            dataChannel.onopen = () => console.log("数据通道已打开");
            dataChannel.onclose = () => console.log("数据通道已关闭");
            dataChannel.onmessage = handleMessage;
        };

        const handleMessage = (event) => {
            const message = JSON.parse(event.data);
            if (message.type === 'ping') {
                resultDiv.innerHTML += `收到 Ping ${message.id}<br>`;
                dataChannel.send(JSON.stringify({ type: 'pong', id: message.id }));
            } else if (message.type === 'pong') {
                const latency = Date.now() - message.id;
                resultDiv.innerHTML += `Pingpong ${message.id}: ${latency}ms<br>`;
            }
        };

        const showNotification = (message) => {
            notificationDiv.textContent = message;
            notificationDiv.style.display = 'block';
            setTimeout(() => {
                notificationDiv.style.display = 'none';
            }, 3000);
        };

        const connectToSignalServer = () => {
            const signalServerUrl = signalServerInput.value;
            socket = new WebSocket(signalServerUrl);

            socket.onopen = () => {
                console.log('已连接到信令服务器');
                showNotification('已连接到信令服务器');
            };

            socket.onmessage = async (event) => {
                const message = JSON.parse(event.data);
                if (message.type === 'offer') {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    socket.send(JSON.stringify({ type: 'answer', answer: answer }));
                } else if (message.type === 'answer') {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
                } else if (message.type === 'ice-candidate') {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                }
            };

            socket.onclose = () => {
                console.log('与信令服务器的连接已关闭');
                showNotification('与信令服务器的连接已关闭');
            };

            socket.onerror = (error) => {
                console.error('信令服务器错误：', error);
                showNotification('信令服务器错误');
            };
        };

        roleSelect.addEventListener('change', async () => {
            isInitiator = roleSelect.value === 'initiator';
            createPeerConnection();
            connectToSignalServer();

            if (isInitiator) {
                createDataChannel();
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer).catch(err => console.error("设置本地描述错误：", err));
                socket.send(JSON.stringify({ type: 'offer', offer: offer }));
            } else if (roleSelect.value === 'receiver') {
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel();
                };
            }
        });

        startPingpongButton.addEventListener('click', () => {
            startPingpongButton.style.display = 'none';
            stopPingpongButton.style.display = 'inline';
            resultDiv.innerHTML = '';
            let pingId = 0;

            pingpongInterval = setInterval(() => {
                if (dataChannel && dataChannel.readyState === 'open') {
                    dataChannel.send(JSON.stringify({ type: 'ping', id: Date.now() }));
                    pingId++;
                }
            }, 1000);
        });

        stopPingpongButton.addEventListener('click', () => {
            clearInterval(pingpongInterval);
            startPingpongButton.style.display = 'inline';
            stopPingpongButton.style.display = 'none';
        });
    </script>
</body>
</html>